<!--
Copyright (c) 2014 Synerzip. All rights reserved.
This code may only be used under the Apache 2.0 style license found at http://www.apache.org/licenses/LICENSE-2.0
Code distributed by Synerzip as part of its showcase apps built on Polymer https://github.com/Synerzip/kinoscribe
-->

<link rel="import" href="../polymer/polymer.html">


<!--
Element providing solution to creating prezi like slideshow in browser

##### Example

    <kino-pres>
        <kino-slide x="100" y="100" z="-100" rotateX="30" rotateY="30" rotateZ="0" scale=3">
            <kino-layout type="title-content">
                <kino-title>
                    Slide 1
                </kino-title>
                <kino-content>
                    <ul>
                        <li>Point 1</li>
                        <li>Point 2</li>
                        <li>Point 3</li>
                    </ul>
                </kino-content>
            </kino-layout>
        </kino-slide>
    </kino-pres>

@element kino-pres
@blurb Element providing solution to creating prezi like slideshow in browser
@status alpha
@homepage http://github.com/Synerzip/kinoscribe
-->
<polymer-element name="kino-pres" type="transition">

<template>

    <style>
        :host {
        }
        #preso{
            position: absolute;
            left: 50%;
            top: 50%;
        }
    </style>
    <article id="preso">
        <section id="container">
            <content select="kino-slide"></content>
        </section>
    </article>

</template>

<script>

    Polymer('kino-pres', {
        /**
         * Current slide being shown
         *
         * @property currentSlide
         * @type num
         */
        currentSlide: 0,
        /**
         * All the Transition Steps for KinoScribe Presentation
         *
         * @property aProp
         * @type bool
         */
        steps: [],

        /**
         *
         */
        config: {
            width: 1024,
            height: 768,
            maxScale: 1,
            minScale: 0,
            perspective: 1000,
            transitionDuration: 1000
        },


        /**
         *
         */
        attached: function () {
            var self = this;
            var nodes = this.getChildNodes();
            nodes[0].active = true;
            for (var index = 0; index < nodes.length; index++) {
                var node = nodes[index];
                var step = {
                    x: 0, y: 0, z: 0,
                    rotateX: 0, rotateY: 0, rotateZ: 0,
                    scale: 1
                };
                if (node.attributes.x != null) {
                    step.x = toNumber(node.attributes.x.value);
                }
                if (node.attributes.y != null) {
                    step.y = toNumber(node.attributes.y.value);
                }
                if (node.attributes.z != null) {
                    step.z = toNumber(node.attributes.z.value);
                }
                if (node.attributes.rotateZ != null) {
                    step.rotateZ = toNumber(node.attributes.rotateZ.value);
                }
                if (node.attributes.rotateY != null) {
                    step.rotateY = toNumber(node.attributes.rotateY.value);
                }
                if (node.attributes.rotateX != null) {
                    step.rotateX = toNumber(node.attributes.rotateX.value);
                }

                if (node.attributes.scale != null) {
                    step.scale = toNumber(node.attributes.scale.value, 1);
                }
                else {
                    step.scale = 1;
                }
                this.steps[index] = step;
            }
            this.applyCounterMove(this);


            document.addEventListener("keydown", function (event) {

                if (37 === event.keyCode) { //Prev
                    self.currentSlide = self.prevSlideNum();
                    self.applyCounterMove(self);

                }
                else if (39 === event.keyCode) {//next
                    self.currentSlide = self.nextSlideNum();
                    self.applyCounterMove(self);
                }
            }, true);
        },

        currentSlideChanged: function (oldValue, newValue) {
            var nodes = this.getChildNodes();
            nodes[oldValue].active = false;
            nodes[newValue].active = true;

        },
        prevSlideNum: function () {
            return this.currentSlide < 1 ? 0 : (this.currentSlide - 1);
        },
        nextSlideNum: function () {
            return this.currentSlide >= (this.steps.length - 1) ? (this.steps.length - 1) : (this.currentSlide + 1);
        },

        applyCounterMove: function (self) {



            window.scrollTo(0, 0);
            var css = new Style();
            var step = self.steps[self.currentSlide];


            var root = self.$.preso;
            var targetScale = inverse(step.scale) * this.windowScale(this.config);
            var perspectiveValue = this.config.perspective / targetScale;
            var scaleValue = targetScale;

            var transformBuilder = new TransformBuilder();
            var transform = transformBuilder
                    .perspective(perspectiveValue)
                    .scale(scaleValue)
                    .transform;

            var style={
                position:"absolute",
                webkitTransformationOrigin : "0% 0%",
                transition:"all 1000ms ease-in-out 0ms",
                top:"50%",
                left:"50%",
                transformStyle:"preserve-3d",
                transform:transform
            }
            css.apply(root,style);

            var container = self.$.container;

            var transformBuilder = new TransformBuilder();
            var transform = transformBuilder
                    .rotate3d(negate(step.rotateX),negate(step.rotateY),negate(step.rotateZ),true)
                    .translate3d(negate(step.x),negate(step.y),negate(step.z))
                    .transform
            var style={
                position:"absolute",
                webkitTransformationOrigin : "0% 0%",
                transition:"all 1000ms ease-in-out 0ms",
                transformStyle:"preserve-3d",
                transform:transform
            }
            css.apply(container,style);

        },

        windowScale: function (config) {
            var hScale = window.innerHeight / config.height,
                    wScale = window.innerWidth / config.width,
                    scale = hScale > wScale ? wScale : hScale;

            if (config.maxScale && scale > config.maxScale) {
                scale = config.maxScale;
            }

            if (config.minScale && scale < config.minScale) {
                scale = config.minScale;
            }

            return scale;
        },

        getChildNodes: function () {
            var container = this.$.container;
            var nodes = container.children[0].getDistributedNodes();
            return nodes;
        }
    });

</script>

</polymer-element>


<!--
Element providing solution to creating slides under kino-pres element

##### Example

    <kino-pres>
        <kino-slide x="100" y="100" z="-100" rotateX="30" rotateY="30" rotateZ="0" scale=3">
            <kino-layout type="title-content">
                <kino-title>
                    Slide 1
                </kino-title>
                <kino-content>
                    <ul>
                        <li>Point 1</li>
                        <li>Point 2</li>
                        <li>Point 3</li>
                    </ul>
                </kino-content>
            </kino-layout>
        </kino-slide>
    </kino-pres>

@element kino-slide
@blurb Element providing solution to creating slides under kino-pres element
@status alpha
@homepage http://github.com/Synerzip/kinoscribe
-->

<polymer-element name="kino-slide" attributes="x y z rotateX rotateY rotateZ scale active">

    <template>

        <style>
            :host {
            }

            #slide {
                position: relative;
            }

            .active {
                opacity: 1;
            }

            .inactive {
                opacity: 0.2;
            }

            ::content layout {
                width: 100%;
                height: 100%;
            }
        </style>

        <section id="slide" class="{{active==true?'active':'inactive'}}">
            <content></content>
        </section>

    </template>
    <script src="style.js"></script>
    <script>


        Polymer('kino-slide', {


            /**
             * The `x` position of the slide on the 3D Presentation Canvas
             *
             * @attribute x
             * @type num
             * @default 0
             */
            x: 0,

            /**
             * The `y` position of the slide on the 3D Presentation Canvas
             *
             * @attribute y
             * @type num
             * @default 0
             */
            y: 0,

            /**
             * The `z` position of the slide on the 3D Presentation Canvas
             *
             * @attribute z
             * @type num
             * @default 0
             */
            z: 0,

            /**
             * The angle of rotation along 'x' axis of the slide on the 3D Presentation Canvas
             *
             * @attribute rotateX
             * @type num
             * @default 0
             */
            rotateX: 0,

            /**
             * The angle of rotation along 'y' axis of the slide on the 3D Presentation Canvas
             *
             * @attribute rotateY
             * @type num
             * @default 0
             */
            rotateY: 0,

            /**
             * The angle of rotation along 'z' axis of the slide on the 3D Presentation Canvas
             *
             * @attribute rotateZ
             * @type num
             * @default 0
             */
            rotateZ: 0,

            /**
             * The magnification scale of this slide
             *
             * @attribute scale
             * @type num
             * @default 1
             */
            scale: 1,

            /**
             * Indication of this slide being the Active/Current Slide being shown
             *
             * @attribute active
             * @type bool
             * @default false
             */
            active: false,


            domReady: function () {

                var elem = this.$.slide;

                var css = new Style();
                var transformBuilder = new TransformBuilder();

                var style={
                    position:"absolute",
                    transformStyle:"preserve-3d",
                    transform:transformBuilder
                                .translate("-50%","-50%")
                                .translate3d(this.x,this.y,this.z)
                                .rotate3d(this.rotateX,this.rotateY,this.rotateZ)
                                .scale(this.scale)
                                .transform
                }
                css.apply(elem,style);

            }



        });

    </script>

</polymer-element>



